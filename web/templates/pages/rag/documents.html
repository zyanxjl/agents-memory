{% extends "base.html" %}

{% block content %}
<div x-data="ragDocumentsPage()" x-init="init()">
    
    <!-- 页面头部 -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold">文档管理</h1>
            <p class="text-slate-400 mt-1">上传和管理知识库文档</p>
        </div>
        <label class="btn btn-primary cursor-pointer">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
            </svg>
            上传文档
            <input type="file" class="hidden" @change="uploadFile($event)" accept=".pdf,.doc,.docx,.md,.txt">
        </label>
    </div>
    
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="stat-card">
            <div class="stat-icon bg-gradient-to-br from-blue-500 to-blue-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </div>
            <div>
                <div class="stat-value" x-text="stats.total_documents || 0"></div>
                <div class="stat-label">文档总数</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-gradient-to-br from-purple-500 to-purple-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M4 6h16M4 12h16m-7 6h7"/>
                </svg>
            </div>
            <div>
                <div class="stat-value" x-text="stats.total_chunks || 0"></div>
                <div class="stat-label">分块总数</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-gradient-to-br from-green-500 to-green-600">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
            </div>
            <div>
                <div class="stat-value" x-text="formatFileSize(stats.total_chars || 0)"></div>
                <div class="stat-label">总字符数</div>
            </div>
        </div>
    </div>
    
    <!-- 上传进度 -->
    <div x-show="uploading" class="card mb-6">
        <div class="card-body">
            <div class="flex items-center space-x-4">
                <div class="loading-spinner"></div>
                <span>正在上传文档...</span>
            </div>
        </div>
    </div>
    
    <!-- 文档列表 -->
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold">文档列表</h3>
        </div>
        <div class="card-body">
            <template x-if="loading">
                <div class="flex justify-center py-8">
                    <div class="loading-spinner"></div>
                </div>
            </template>
            
            <template x-if="!loading && documents.length === 0">
                <div class="text-center py-12 text-slate-400">
                    <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p>暂无文档</p>
                    <p class="text-sm mt-2">上传您的第一个文档开始构建知识库</p>
                </div>
            </template>
            
            <template x-if="!loading && documents.length > 0">
                <div class="space-y-4">
                    <template x-for="doc in documents" :key="doc.doc_id">
                        <div class="flex items-center justify-between p-4 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 transition-colors">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-medium" x-text="doc.filename"></div>
                                    <div class="text-sm text-slate-400">
                                        <span x-text="doc.chunk_count + ' 个分块'"></span>
                                        <span class="mx-2">•</span>
                                        <span x-text="formatRelativeTime(doc.upload_time)"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="badge" :class="doc.status === 'ready' ? 'badge-success' : 'badge-warning'"
                                      x-text="doc.status === 'ready' ? '就绪' : '处理中'"></span>
                                <button @click="deleteDocument(doc.doc_id)" 
                                        class="btn btn-ghost btn-sm text-red-400 hover:text-red-300">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script>
function ragDocumentsPage() {
    return {
        documents: [],
        stats: {},
        loading: true,
        uploading: false,
        
        async init() {
            await Promise.all([
                this.loadDocuments(),
                this.loadStats(),
            ]);
        },
        
        async loadDocuments() {
            this.loading = true;
            try {
                const response = await RAGAPI.listDocuments();
                this.documents = response.data || [];
            } catch (error) {
                showToast('加载文档失败', 'error');
            } finally {
                this.loading = false;
            }
        },
        
        async loadStats() {
            try {
                const response = await RAGAPI.stats();
                this.stats = response.data || {};
            } catch (error) {
                console.error('加载统计失败', error);
            }
        },
        
        async uploadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            this.uploading = true;
            try {
                await RAGAPI.uploadDocument(file);
                showToast('文档上传成功', 'success');
                await Promise.all([
                    this.loadDocuments(),
                    this.loadStats(),
                ]);
            } catch (error) {
                showToast('上传失败: ' + error.message, 'error');
            } finally {
                this.uploading = false;
                event.target.value = '';
            }
        },
        
        async deleteDocument(docId) {
            if (!await confirmDialog('确定要删除这个文档吗？')) return;
            try {
                await RAGAPI.deleteDocument(docId);
                showToast('删除成功', 'success');
                await Promise.all([
                    this.loadDocuments(),
                    this.loadStats(),
                ]);
            } catch (error) {
                showToast('删除失败: ' + error.message, 'error');
            }
        }
    };
}
</script>
{% endblock %}

